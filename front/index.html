<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>TalkBot</title>
	<!-- Liens vers les fichiers CSS de Flowbite -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.6.5/flowbite.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="./assets/style.css">

  <script>
    document.addEventListener('DOMContentLoaded',init);

    let botList;

    function init(){
      botList = document.getElementById("grid-container")

      displayBots();
    }

    async function displayBots() {
        while (botList.firstChild) {
  				botList.removeChild(botList.firstChild);
			  }

        let myHeaders = new Headers();
        myHeaders.append('Content-Type', 'application/x-www-form-urlencoded; charset=UTF-8');
        myHeaders.append('Accept', 'application/json');
        myHeaders.append('Set-Cookie', 'passPhrase=Hop');

        let myInit = { 
          method: 'GET',
                  headers: myHeaders,
                  credentials: 'same-origin',
                  mode: 'cors',
                  cache: 'no-store' 
              };

        let myURL = `http://localhost:3000/`;

        fetch(myURL,myInit)
          .then((httpResponse)=>{
            for(let field of httpResponse.headers){
              console.log(`raw = ${field}`);
            }	
            return httpResponse.json()
          })
          .then((bots)=>{
            for(let bot of bots){
              const botElement = document.createElement("div");
              botElement.classList.add("bg-gray-100", "p-4", "rounded-md", "relative");

              const deleteBtn = document.createElement("button");
              deleteBtn.classList.add("absolute", "bottom-2", "right-2", "cursor-pointer");
              deleteBtn.style.width = "25px"; // ajouter une largeur de 50px
              deleteBtn.style.height = "25px"; // ajouter une hauteur de 50px
              deleteBtn.style.backgroundImage = "url(assets/img/trash.svg)"; // ajouter l'image
              deleteBtn.style.backgroundRepeat = "no-repeat"; // éviter la répétition de l'image
              deleteBtn.addEventListener("click", () => deleteBot(bot.id));

              const startBtn = document.createElement("button");
              startBtn.classList.add("absolute", "top-5", "right-2", "cursor-pointer");
              startBtn.id = "start-btn-" + bot.id
              startBtn.style.width = "25px"; // ajouter une largeur de 50px
              startBtn.style.height = "25px"; // ajouter une hauteur de 50px
              startBtn.style.backgroundImage = "url(assets/img/start.svg)"; // ajouter l'image
              startBtn.style.backgroundRepeat = "no-repeat"; // éviter la répétition de l'image
              startBtn.addEventListener("click", () => startBot(bot.id));

              const botName = document.createElement("h2");
              botName.textContent = bot.name;
              botName.classList.add("text-lg", "font-medium", "mb-2");

              const botId = document.createElement("p");
              botId.textContent = `ID: ${bot.id}`;

              const botPort = document.createElement("p");
              botPort.textContent = `Port: ${bot.port}`;

              botElement.appendChild(startBtn);
              botElement.appendChild(deleteBtn);
              botElement.appendChild(botName);
              botElement.appendChild(botId);
              botElement.appendChild(botPort);

              botList.appendChild(botElement);
            }
          })
          .catch((err)=>{
            console.log(`ERROR : ${err}`);
          })
      }

      function deleteBot(id){
        let myHeaders = new Headers();
			  myHeaders.append('Content-Type', 'application/json');

        let myInit = { 
          method: 'DELETE',
          headers: myHeaders,
          mode: 'cors',
          cache: 'default' 
        };

        let myURL = `http://localhost:3000/${id}`;
        
        fetch(myURL,myInit)
          .then((httpResponse)=>{
            return httpResponse.text()
          })
          .then((returnString)=>{
            displayBots();
            console.log(`${returnString}`)
          })
          .catch((err)=>{
            console.log(`ERROR : ${err}`);
          })		
        }

        function startBot(id) {
            const btn = document.getElementById(`start-btn-${id}`);
            fetch(`http://localhost:3000/start-stop/${id}`, { method: 'POST' })
                .then(response => {
                    if (response.ok) {
                        response.text().then(returnString => {
                            console.log(`${returnString}`)
                            if (returnString === 'Bot started') {
                                btn.style.backgroundImage = "url(assets/img/stop.svg)";
                            } else {
                                btn.style.backgroundImage = "url(assets/img/start.svg)";
                            }
                        });
                    } else {
                        alert('Error: ' + response.statusText);
                    }
                })
                .catch(error => {
                    alert('Error: ' + error.message);
                });
        }
    
  </script>
</head>
<body>

    
<nav class="bg-white dark:bg-gray-900 fixed w-full z-20 top-0 left-0 border-b border-gray-200 dark:border-gray-600">
    <div class="max-w-screen-xl flex flex-wrap items-center justify-between mx-auto p-4">
    <a href="https://flowbite.com/" class="flex items-center">
        <img src="https://st3.depositphotos.com/8950810/17657/v/600/depositphotos_176577880-stock-illustration-cute-smiling-funny-robot-chat.jpg" class="h-8 mr-3" alt="Flowbite Logo">
        <span class="self-center text-2xl font-semibold whitespace-nowrap dark:text-white">TalkBot</span>
    </a>
    <div class="flex md:order-2">
        <button data-collapse-toggle="navbar-sticky" type="button" class="inline-flex items-center p-2 text-sm text-gray-500 rounded-lg md:hidden hover:bg-gray-100 focus:outline-none focus:ring-2 focus:ring-gray-200 dark:text-gray-400 dark:hover:bg-gray-700 dark:focus:ring-gray-600" aria-controls="navbar-sticky" aria-expanded="false">
          <span class="sr-only">Open main menu</span>
          <svg class="w-6 h-6" aria-hidden="true" fill="currentColor" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><path fill-rule="evenodd" d="M3 5a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 10a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zM3 15a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1z" clip-rule="evenodd"></path></svg>
        </button>
    </div>
    <div class="items-center justify-between hidden w-full md:flex md:w-auto md:order-1" id="navbar-sticky">
      <ul class="flex flex-col p-4 md:p-0 mt-4 font-medium border border-gray-100 rounded-lg bg-gray-50 md:flex-row md:space-x-8 md:mt-0 md:border-0 md:bg-white dark:bg-gray-800 md:dark:bg-gray-900 dark:border-gray-700">
        <li>
          <a href="#" class="block py-2 pl-3 pr-4 text-white bg-blue-700 rounded md:bg-transparent md:text-blue-700 md:p-0 md:dark:text-blue-500" aria-current="page">Accueil</a>
        </li>
        <li>
          <a href="./add_bot.html" class="block py-2 pl-3 pr-4 text-gray-900 rounded hover:bg-gray-100 md:hover:bg-transparent md:hover:text-blue-700 md:p-0 md:dark:hover:text-blue-500 dark:text-white dark:hover:bg-gray-700 dark:hover:text-white md:dark:hover:bg-transparent dark:border-gray-700">Ajouter un bot</a>
        </li>
      </ul>
    </div>
    </div>
  </nav>

  <div class="grid grid-cols-3 gap-4" id="grid-container">
  </div>

	<!-- Liens vers les fichiers JavaScript de Flowbite -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/flowbite/1.6.5/flowbite.min.js"></script>
</body>
</html>

